/* Modifies for add menagement of notes linked to user */
ALTER TABLE SBI_OBJECT_NOTES ADD OWNER VARCHAR(50);
ALTER TABLE SBI_OBJECT_NOTES ADD ISPUBLIC BOOLEAN;
ALTER TABLE SBI_OBJECT_NOTES ADD  CREATION_DATE TIMESTAMP ;
ALTER TABLE SBI_OBJECT_NOTES ADD  LAST_CHANGE_DATE TIMESTAMP  NULL;
ALTER TABLE SBI_DATA_SET ADD  DS_METADATA VARCHAR(2000) DEFAULT NULL;
ALTER TABLE SBI_SUBOBJECTS ALTER COLUMN DESCRIPTION VARCHAR(1000) DEFAULT NULL;
/* force a valid value for date fields in existing records: */
UPDATE SBI_OBJECT_NOTES SET LAST_CHANGE_DATE = NOW(),CREATION_DATE = NOW();

/* force a valid value for owner field in existing records: 
***************************** ATTENTION **********************************
* The OWNER value depends from your context... 
we suggest 'biadmin' because is the classic admin user in SpaogoBI demo: 
you should change this value with a valid user in your platfrom, in this way 
he may change or delete the EXISTING notes!!*/
UPDATE SBI_OBJECT_NOTES SET OWNER = 'biadmin';
/*************************************************************************/
COMMIT;

/* Modifies for add possibility to update subobjects. It's necessary delete all subobjects where 
name is null because we add not null constraint to name column. */
DELETE FROM SBI_REMEMBER_ME WHERE SUBOBJ_ID IN (SELECT SUBOBJ_ID FROM SBI_SUBOBJECTS WHERE NAME IS NULL OR NAME ='');
DELETE FROM SBI_AUDIT WHERE SUBOBJ_ID IN (SELECT SUBOBJ_ID FROM SBI_SUBOBJECTS WHERE NAME IS NULL OR NAME ='');
DELETE FROM SBI_MENU WHERE SUBOBJ_NAME IN (SELECT NAME FROM SBI_SUBOBJECTS WHERE NAME IS NULL OR NAME ='');
DELETE FROM SBI_BINARY_CONTENTS WHERE BIN_ID IN (SELECT BIN_ID FROM SBI_SUBOBJECTS WHERE NAME IS NULL OR NAME ='');
DELETE FROM SBI_SUBOBJECTS WHERE NAME IS NULL OR NAME =''; 
COMMIT;
ALTER TABLE SBI_SUBOBJECTS ALTER COLUMN NAME VARCHAR(50) NOT NULL

/* Modified for metadata management */
ALTER TABLE SBI_OBJECTS DROP COLUMN DESCR_EXT;
ALTER TABLE SBI_OBJECTS DROP COLUMN OBJECTIVE;
ALTER TABLE SBI_OBJECTS DROP COLUMN LANGUAGE;
ALTER TABLE SBI_OBJECTS DROP COLUMN KEYWORDS;

ALTER TABLE SBI_EXT_ROLES ADD COLUMN SAVE_METADATA BOOLEAN DEFAULT TRUE;

CREATE MEMORY TABLE SBI_OBJ_METADATA(OBJ_META_ID INTEGER GENERATED BY DEFAULT AS IDENTITY(START WITH 1) NOT NULL,LABEL VARCHAR NOT NULL,NAME VARCHAR NOT NULL,DESCRIPTION VARCHAR,DATA_TYPE_ID INTEGER NOT NULL,CREATION_DATE TIMESTAMP,CONSTRAINT XPKSBI_OBJ_METADATA PRIMARY KEY(OBJ_META_ID),CONSTRAINT FK_SBI_OBJ_METADATA_1 FOREIGN KEY(DATA_TYPE_ID) REFERENCES SBI_DOMAINS(VALUE_ID));
CREATE MEMORY TABLE SBI_OBJ_METACONTENTS(OBJ_METACONTENT_ID INTEGER GENERATED BY DEFAULT AS IDENTITY(START WITH 1) NOT NULL,OBJMETA_ID INTEGER NOT NULL,BIOBJ_ID INTEGER NOT NULL, SUBOBJ_ID INTEGER, BIN_ID INTEGER, CREATION_DATE TIMESTAMP NOT NULL, LAST_CHANGE_DATE TIMESTAMP NOT NULL,CONSTRAINT XPKSBI_OBJ_METACONTENT PRIMARY KEY(OBJ_METACONTENT_ID),CONSTRAINT FK_SBI_OBJ_METACONTENT_1 FOREIGN KEY(OBJMETA_ID) REFERENCES SBI_OBJ_METADATA(OBJ_META_ID),CONSTRAINT FK_SBI_OBJ_METACONTENT_2 FOREIGN KEY(BIOBJ_ID) REFERENCES SBI_OBJECTS(BIOBJ_ID), CONSTRAINT FK_SBI_OBJ_METACONTENT_3 FOREIGN KEY(SUBOBJ_ID) REFERENCES SBI_SUBOBJECTS(SUBOBJ_ID), CONSTRAINT FK_SBI_OBJ_METACONTENT_4 FOREIGN KEY(BIN_ID) REFERENCES SBI_BINARY_CONTENTS(BIN_ID));


ALTER TABLE SBI_OBJ_METADATA ALTER COLUMN OBJ_META_ID RESTART WITH 1;
ALTER TABLE SBI_OBJ_METACONTENTS ALTER COLUMN OBJ_METACONTENT_ID RESTART WITH 1;

--adds new funcionality for metadata management
INSERT INTO SBI_USER_FUNC (NAME, DESCRIPTION) VALUES ('ObjMetadataManagement', 'ObjMetadataManagement');
INSERT INTO  SBI_ROLE_TYPE_USER_FUNC values((SELECT VALUE_ID FROM SBI_DOMAINS WHERE DOMAIN_CD = 'ROLE_TYPE' AND VALUE_CD = 'ADMIN'), (SELECT USER_FUNCT_ID FROM SBI_USER_FUNC WHERE NAME='ObjMetadataManagement'))
COMMIT;